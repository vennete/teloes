<!DOCTYPE html>
<html lang="pt‚ÄëBR">
<head>
  <meta charset="UTF‚Äë8">
  <title>Projeto de Redirecionamento</title>
  <meta name="viewport" content="width=device-width, initial‚Äëscale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { box‚Äësizing: border-box; margin:0; padding:0; }
    body {
      font-family: 'Inter', sans-serif;
      background: #f0f4f8;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
      animation: fadeInPage 0.8s ease‚Äëin forwards;
    }
    @keyframes fadeInPage {
      from { opacity:0; transform: translateY(20px); }
      to { opacity:1; transform: translateY(0); }
    }
    h1 {
      color: #2c3e50;
      font-size: 32px;
      margin‚Äêbottom: 24px;
      position: relative;
    }
    h1::after {
      content:'';
      display:block;
      width: 65px;
      height:4px;
      background:#3498db;
      margin:10px auto 0;
      border-radius:2px;
      animation: lineGrow 0.6s ease‚Äëout forwards;
    }
    @keyframes lineGrow {
      from { width:0; }
      to { width:65px; }
    }
    #formulario, #statusExecucao, #telaBloqueio {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.05);
      padding: 40px;
      width: 100%;
      max-width: 700px;
      margin-bottom: 50px;
      transition: transform .3s ease, opacity .3s ease;
    }
    #formulario.hidden, #statusExecucao.hidden, #telaBloqueio.hidden {
      opacity: 0;
      transform: translateY(30px);
      pointer-events: none;
    }
    .link-group {
      display: flex;
      gap: 12px;
      margin-bottom: 18px;
      align-items: center;
      transition: all .3s ease;
    }
    .link-group input[type="url"], .link-group input[type="number"] {
      padding: 14px;
      border:1px solid #ccc;
      border-radius:8px;
      flex:1;
      transition: border-color .3s ease, background .3s ease;
    }
    .link-group input[type="url"]:focus, .link-group input[type="number"]:focus {
      border-color: #3498db;
      background: #f9fbfd;
    }
    button {
      margin-top:20px;
      padding:16px 24px;
      border:none;
      background: #3498db;
      color: #fff;
      font-weight:600;
      font-size:16px;
      border-radius:8px;
      cursor:pointer;
      transition: transform .2s ease, background .3s ease;
    }
    button:hover {
      background:#2980b9;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    button:active {
      transform: translateY(0);
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    #codigo {
      font-family: monospace;
      color: #e67e22;
      background: #f7f7f7;
      padding:10px 14px;
      border-radius:6px;
      display:inline-block;
      margin-right:12px;
      transition: background .3s ease;
    }
    #copiarBtn {
      background:none;
      border:none;
      font-size:22px;
      cursor:pointer;
      vertical-align:middle;
      color:#3498db;
      transition: transform .2s ease, color .3s ease;
    }
    #copiarBtn:hover {
      transform: scale(1.2);
      color:#2980b9;
    }
    #exemploUso input {
      font-family: monospace;
      padding:12px;
      border:1px solid #ccc;
      border-radius:8px;
      transition: border-color .3s ease;
    }
    #exemploUso button {
      margin-top:0;
      padding:12px;
      font-size:18px;
    }
    #admButtons {
      margin-top:24px;
      display:none;
      gap:10px;
    }
    #admButtons button {
      padding:14px 20px;
      font-size:16px;
    }
    .remover-btn {
      background:#e74c3c;
      color:#fff;
      border:none;
      padding:0 16px;
      font-size:18px;
      border-radius:6px;
      cursor:pointer;
      height:44px;
      transition: transform .2s ease, background .3s ease;
    }
    .remover-btn:hover {
      background:#c0392b;
      transform: translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }
    @media (max-width: 520px) {
      .link-group {
        flex-direction:column;
        align-items:stretch;
      }
      .remover-btn {
        width:100%;
        margin-top:6px;
      }
    }
    #iframeExec {
      position: fixed;
      top:0;
      left:0;
      width:100vw;
      height:100vh;
      border:none;
      margin:0;
      padding:0;
      z-index:999;
      background:#000;
    }
    /* Tela de bloqueio estilizada */
    #telaBloqueio {
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:60px;
      text-align:center;
    }
    #telaBloqueio h2 {
      color:#c0392b;
      font-size:28px;
      margin-bottom:20px;
      animation: shakeText 0.6s ease‚Äëin‚Äëout infinite alternate;
    }
    @keyframes shakeText {
      from { transform: translateX(-3px); }
      to { transform: translateX(3px); }
    }
    #telaBloqueio p {
      font-size:18px;
      line-height:1.5;
      color:#555;
    }
  </style>
</head>
<body>
  <h1 id="titulo">Carregando...</h1>

  <div id="formulario" class="hidden">
    <p><strong>C√≥digo gerado:</strong>
      <span id="codigo"></span>
      <button id="copiarBtn" title="Copiar c√≥digo">üìã</button>
    </p>

    <div id="linksContainer"></div>
    <button id="addBtn">‚ûï Adicionar Link</button>
    <button id="salvarBtn" disabled>üíæ Salvar Projeto</button>

    <div id="admButtons">
      <button id="ativarBtn" style="background:#2ecc71;">‚úÖ Ativar Projeto</button>
      <button id="desativarBtn" style="background:#e74c3c;">‚ùå Desativar Projeto</button>
    </div>

    <div id="exemploUso" class="hidden" style="margin-top:30px;">
      <h3>üîó Uso do Projeto:</h3>
      <p>Copie o link abaixo e compartilhe:</p>
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="linkCompleto" readonly style="flex:1; padding:12px; border:1px solid #ccc; border-radius:8px;" />
        <button id="copiarLink" title="Copiar link">üìã</button>
      </div>
    </div>
  </div>

  <div id="statusExecucao" class="hidden">
    <h2>Executando Projeto <span id="execCodigo"></span></h2>
    <p id="atual">Carregando...</p>
    <iframe id="iframeExec" class="hidden"></iframe>
  </div>

  <div id="telaBloqueio" class="hidden">
    <h2>üö´ Projeto Desabilitado</h2>
    <p>Este projeto foi desativado pela equipe de Business Intelligence.<br>Se precisar reativar, entre em contato com o time respons√°vel.</p>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyuDRwXWylQkvu5P8UdLRpXkBx-stPdLWMW83Wq8joU0ZYu5gBtrpXbCknD1L76qp3ldA/exec';
    const params = new URLSearchParams(location.search);
    const isRegistrar = params.has('registrar');
    const editarParam = params.get('editar');
    const isEditar = params.has('editar');
    const isAdminEdit = isEditar && editarParam === 'adm';
    const codigoParam = params.get('codigo');
    const elForm = document.getElementById('formulario');
    const elExec = document.getElementById('statusExecucao');
    const elTitulo = document.getElementById('titulo');
    const elCodigo = document.getElementById('codigo');
    const elLinksContainer = document.getElementById('linksContainer');
    const elAtual = document.getElementById('atual');
    const elIframe = document.getElementById('iframeExec');
    const elExecCodigo = document.getElementById('execCodigo');
    const admButtonsDiv = document.getElementById('admButtons');
    const btnAtivar = document.getElementById('ativarBtn');
    const btnDesativar = document.getElementById('desativarBtn');
    const telaBloqueio = document.getElementById('telaBloqueio');
    const MAX_LINKS = 5;

    let codigoProjeto = null;
    let passos = [];
    let idx = 0;
    let intervaloAtualizacao = null;
    let projetoAtivo = true;

    console.log("üîç Script iniciado. Par√¢metros:", params.toString());

    if (isRegistrar) {
      iniciarCadastro();
    } else if (isEditar && codigoParam) {
      iniciarEdicao(codigoParam);
    } else if (codigoParam) {
      iniciarExecucao(codigoParam);
    } else {
      elTitulo.textContent = "Par√¢metro inv√°lido ou c√≥digo n√£o informado.";
    }

    async function iniciarCadastro() {
      elTitulo.textContent = 'Registrar Novo Projeto';
      elForm.classList.remove('hidden');
      addLinkGroup();

      document.getElementById('addBtn').onclick = () => {
        const count = elLinksContainer.querySelectorAll('.link-group').length;
        if (count < MAX_LINKS) addLinkGroup();
        else alert('M√°ximo de 5 links permitido!');
      };

      document.getElementById('salvarBtn').onclick = () => salvarProjeto(false);

      const codigoGerado = await gerarCodigo();
      elCodigo.textContent = codigoGerado;
      elCodigo.dataset.valor = codigoGerado;
      document.getElementById('salvarBtn').disabled = false;

      document.getElementById('copiarBtn').onclick = () => {
        navigator.clipboard.writeText(codigoGerado).then(() => alert('C√≥digo copiado!'));
      };
    }

    async function iniciarEdicao(codigo) {
      codigoProjeto = codigo;
      elTitulo.textContent = isAdminEdit ? `Editar Projeto (ADMIN) ${codigo}` : `Editar Projeto ${codigo}`;
      elForm.classList.remove('hidden');

      const data = await obterProjeto();
      console.log("üì• Dados carregados para edi√ß√£o:", data);

      if (!data || data.erro) {
        alert('Erro ao carregar dados para edi√ß√£o.');
        return;
      }

      elCodigo.textContent = codigo;
      elCodigo.dataset.valor = codigo;
      document.getElementById('salvarBtn').disabled = false;

      elLinksContainer.innerHTML = '';
      (data.passos || []).forEach((p,i) => {
        addLinkGroup(p.link, p.tempo);
      });

      document.getElementById('addBtn').onclick = () => {
        const count = elLinksContainer.querySelectorAll('.link-group').length;
        if (count < MAX_LINKS) addLinkGroup();
        else alert('M√°ximo de 5 links permitido!');
      };

      document.getElementById('salvarBtn').onclick = () => salvarProjeto(true);

      if (isAdminEdit) {
        admButtonsDiv.style.display = 'flex';
        updateAdmButtons(data.gestao);
        btnAtivar.onclick = () => alterarGestaoProjeto('Ativo');
        btnDesativar.onclick = () => alterarGestaoProjeto('Inativo');
      } else {
        admButtonsDiv.style.display = 'none';
      }
    }

    async function gerarCodigo() {
      try {
        const res = await fetch('https://api.ipify.org?format=json');
        const ip = (await res.json()).ip || '000.000.000.000';
        const ultimos3 = ip.split('.').pop().padStart(3,'0');
        const now = new Date();
        const hh = now.getHours().toString().padStart(2,'0');
        const mm = now.getMinutes().toString().padStart(2,'0');
        const dd = now.getDate().toString().padStart(2,'0');
        const MM = (now.getMonth()+1).toString().padStart(2,'0');
        const yy = now.getFullYear().toString().slice(-2);
        return `${ultimos3}${hh}${mm}${dd}${MM}${yy}`;
      } catch(err) {
        console.error('Erro ao gerar c√≥digo:', err);
        return `ERR${Date.now()}`;
      }
    }

    function addLinkGroup(prefillLink = '', prefillTempo = '') {
      const count = elLinksContainer.querySelectorAll('.link-group').length;
      const div = document.createElement('div');
      div.className = 'link-group';
      div.innerHTML = `
        <input type="url" placeholder="Link (https://‚Ä¶)" class="link" value="${prefillLink}" required />
        <input type="number" placeholder="Tempo (segundos)" class="tempo" min="1" value="${prefillTempo}" required />
        ${count >= 1 ? '<button type="button" class="remover-btn">‚ûñ</button>' : ''}
      `;
      elLinksContainer.appendChild(div);

      if (count >= 1) {
        const btn = div.querySelector('.remover-btn');
        btn.addEventListener('click', () => {
          div.style.opacity = '0';
          div.style.transform = 'translateX(-20px)';
          setTimeout(() => div.remove(), 300);
        });
      }
    }

    function salvarProjeto(isEditing) {
      const codigo = elCodigo.dataset.valor;
      if (!codigo) { alert("Erro: c√≥digo n√£o gerado."); return; }
      const links = [...elLinksContainer.querySelectorAll('.link')].map(el => el.value.trim());
      const tempos = [...elLinksContainer.querySelectorAll('.tempo')].map(el => Number(el.value.trim()));

      if (links.length === 0) { alert("Adicione ao menos um link."); return; }
      for (let i=0; i<links.length; i++){
        if (!links[i] || !tempos[i]|| isNaN(tempos[i])|| tempos[i]<=0){
          alert(`Preencha link ${i+1} e tempo correspondente.`); return;
        }
        if (!/^https?:\/\//i.test(links[i])) {
          alert(`Link ${i+1} precisa iniciar com http:// ou https://`); return;
        }
      }

      const paramsArr = [`codigo=${encodeURIComponent(codigo)}`];
      if (isEditing) paramsArr.push('editar=true');
      links.forEach((link,i) => {
        paramsArr.push(`link${i+1}=${encodeURIComponent(link)}`);
        paramsArr.push(`tempo${i+1}=${encodeURIComponent(tempos[i])}`);
      });

      const url = `${API_URL}?${paramsArr.join('&')}`;
      let iframeHidden = document.getElementById('invisibleFrame');
      if (!iframeHidden) {
        iframeHidden = document.createElement('iframe');
        iframeHidden.id = 'invisibleFrame';
        iframeHidden.style.display='none';
        document.body.appendChild(iframeHidden);
      }
      iframeHidden.src = url;

      alert(isEditing ? `Projeto ${codigo} atualizado!` : `Projeto ${codigo} salvo!`);

      if (!isEditing) {
        location.href = `${location.pathname}?editar&codigo=${codigo}`;
        return;
      }

      document.getElementById('exemploUso').classList.remove('hidden');
      const linkExec = `${location.origin}${location.pathname}?codigo=${codigo}`;
      const inputLink = document.getElementById('linkCompleto');
      inputLink.value = linkExec;
      document.getElementById('copiarLink').onclick = () => {
        navigator.clipboard.writeText(linkExec).then(() => alert('Link copiado para a √°rea de transfer√™ncia!'));
      };
    }

    async function iniciarExecucao(codigo) {
      codigoProjeto = codigo;
      elExecCodigo.textContent = codigoProjeto;
      elTitulo.style.display='none';
      elForm.classList.add('hidden');
      elExec.classList.remove('hidden');
      elIframe.classList.remove('hidden');

      const data = await obterProjeto();
      console.log("üì• Dados iniciais execu√ß√£o:", data);

      if (!data || data.erro || !data.passos) {
        elAtual.textContent = data?.erro || 'Erro ao carregar projeto.';
        return;
      }
      if (data.gestao && data.gestao.toLowerCase() !== 'ativo') {
        mostrarBloqueio();
        return;
      }

      passos = data.passos;
      projetoAtivo = true;

      // envio imediato
      await enviarAtualizacaoTempo(0);

      // envio peri√≥dico
      intervaloAtualizacao = setInterval(() => { enviarAtualizacaoTempo(1); }, 60*1000);

      idx = 0;
      redirecionar();
    }

    function redirecionar() {
      if (!projetoAtivo) return;
      if (passos.length === 0) {
        elAtual.textContent = "Nenhum link definido.";
        return;
      }
      const atual = passos[idx];
      elAtual.textContent = `Carregando: ${atual.link} (tempo: ${atual.tempo}s)`;
      elIframe.src = atual.link;

      setTimeout(() => {
        idx = (idx + 1) % passos.length;
        redirecionar();
      }, atual.tempo * 1000);
    }

    async function enviarAtualizacaoTempo(minutos) {
      try {
        const url1 = `${API_URL}?codigo=${encodeURIComponent(codigoProjeto)}&tempoUso=${encodeURIComponent(minutos)}`;
        console.log("üîº Enviando tempoUso:", minutos);
        await fetch(url1);
        const url2 = `${API_URL}?codigo=${encodeURIComponent(codigoProjeto)}`;
        console.log("üîç Buscando dados recentes:", url2);
        const res2 = await fetch(url2);
        const data = await res2.json();
        console.log("üìë Resposta p√≥s envio:", data);

        if (data.erro || !data.passos) {
          encerrarExecucao("‚õî Projeto indispon√≠vel.");
          return;
        }

        passos = data.passos;
        if (data.gestao && data.gestao.toLowerCase() !== 'ativo') {
          mostrarBloqueio();
        }
      } catch(err) {
        console.error("‚ùó Erro ao atualizar tempo ou buscar dados:", err);
      }
    }

    async function obterProjeto() {
      const res = await fetch(`${API_URL}?codigo=${encodeURIComponent(codigoProjeto)}`);
      return await res.json();
    }

    function mostrarBloqueio() {
      projetoAtivo = false;
      clearInterval(intervaloAtualizacao);
      elExec.classList.add('hidden');
      elIframe.classList.add('hidden');
      telaBloqueio.classList.remove('hidden');
      console.log('üö´ Execu√ß√£o interrompida: projeto desativado');
    }

    function encerrarExecucao(mensagem) {
      projetoAtivo = false;
      clearInterval(intervaloAtualizacao);
      elAtual.textContent = mensagem;
      elIframe.classList.add('hidden');
      console.log('üîí Execu√ß√£o encerrada:', mensagem);
    }

    async function alterarGestaoProjeto(novoStatus) {
      if (!confirm(`Tem certeza que deseja marcar este projeto como "${novoStatus}"?`)) return;
      try {
        await fetch(`${API_URL}?codigo=${encodeURIComponent(codigoProjeto)}&gestao=${encodeURIComponent(novoStatus)}`);
        alert(`Projeto marcado como ${novoStatus}!`);
        location.reload();
      } catch(err) {
        alert('‚ùó Erro ao alterar gest√£o.');
        console.error(err);
      }
    }

    function updateAdmButtons(gestao) {
      if (!gestao) return;
      const status = gestao.toLowerCase();
      if (status === 'ativo') {
        btnAtivar.style.display='none';
        btnDesativar.style.display='inline-block';
      } else {
        btnAtivar.style.display='inline-block';
        btnDesativar.style.display='none';
      }
    }
  </script>
</body>
</html>